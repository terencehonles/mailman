#! /usr/bin/env python
#
# Copyright (C) 1998,1999,2000,2001 by the Free Software Foundation, Inc.
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software 
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.

"""Create a new, unpopulated mailing list.

Usage: %(PROGRAM)s [options] listname listadmin-addr admin-password

Options:

    -q
    --quiet
        Normally the administrator is notified by email (after a prompt) that
        their list has been created.  This option suppresses that
        notification and the prompting.

    -h/--help
        Print this help text and exit.

You can specify as many of the arguments as you want on the command line:
you will be prompted for the missing ones.

Note that listnames are forced to lowercase."""

import sys
import os
import getpass
import getopt
import sha

import paths
from Mailman import mm_cfg
from Mailman import MailList
from Mailman import Utils
from Mailman import Errors
from Mailman import Message
from Mailman.i18n import _

PROGRAM = sys.argv[0]



def usage(code, msg=''):
    print >> sys.stderr, _(__doc__)
    if msg:
        print >> sys.stderr, msg
    sys.exit(code)



def main():
    try:
        opts, args = getopt.getopt(sys.argv[1:], 'hq',
                                   ['help', 'quiet'])
    except getopt.error, msg:
        usage(1, msg)

    quiet = 0
    for opt, arg in opts:
        if opt in ('-h', '--help'):
            usage(0)
        if opt in ('-q', '--quiet'):
            quiet = 1

    if len(args) > 0:
	listname = args[0]
    else:
	listname = raw_input(_('Enter the name of the list: '))
    listname = listname.lower()

    if '@' in listname:
        usage(1, _('List name must not include "@": %(listname)s'))

    if Utils.list_exists(listname):
        usage(1, _('List already exists: %(listname)s'))

    if len(args) > 1:
	owner_mail = args[1]
    else:
	owner_mail = raw_input(
	    _('Enter the email of the person running the list: '))

    if len(args) > 2:
	listpasswd = args[2]
    else:
        listpasswd = getpass.getpass(_('Initial %(listname)s password: '))
    # List passwords cannot be empty
    listpasswd = listpasswd.strip()
    if not listpasswd:
        usage(1, _('The list password cannot be empty'))

    mlist = MailList.MailList()
    try:
        pw = sha.new(listpasswd).hexdigest()
        # Guarantee that all newly created files have the proper permission.
        # proper group ownership should be assured by the autoconf script
        # enforcing that all directories have the group sticky bit set
        oldmask = os.umask(002)
        try:
            try:
                mlist.Create(listname, owner_mail, pw)
            finally:
                os.umask(oldmask)
        except Errors.MMBadEmailError:
            usage(1, _('Bad owner email address: %(owner_mail)s'))
        except Errors.MMListAlreadyExistsError:
            usage(1, _('List already exists: %(listname)s'))

        # Now do the MTA-specific list creation tasks
        if mm_cfg.MTA:
            modname = 'Mailman.MTA.' + mm_cfg.MTA
            __import__(modname)
            sys.modules[modname].create(mlist)

        # And send the notice to the list owner
        if not quiet:
            print _('Notifying %(listname)s owner...')
            text = Utils.maketext(
                'newlist.txt',
                {'listname'    : listname,
                 'password'    : listpasswd, 
                 'admin_url'   : mlist.GetScriptURL('admin', absolute=1), 
                 'listinfo_url': mlist.GetScriptURL('listinfo', absolute=1),
                 'requestaddr' : "%s-request@%s" % (listname, mlist.host_name),
                 'hostname'    : mlist.host_name,
                 }, mlist.preferred_language)
            msg = Message.UserNotification(
                owner_mail,
                'mailman-owner@' + mlist.host_name,
                _('Your new mailing list: %(listname)s'),
                text)
            msg.send(mlist)
    finally:
        mlist.Unlock()


if __name__ == '__main__':
    main()
