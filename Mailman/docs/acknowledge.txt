Message acknowledgment
======================

When a user posts a message to a mailing list, and that user has chosen to
receive acknowledgments of their postings, Mailman will sent them such an
acknowledgment.

    >>> from email import message_from_string
    >>> from Mailman.Message import Message
    >>> from Mailman.Handlers.Acknowledge import process
    >>> from Mailman.configuration import config
    >>> from Mailman.database import flush
    >>> mlist = config.list_manager.create('_xtest@example.com')
    >>> mlist.real_name = 'XTest'
    >>> # XXX This will almost certainly change once we've worked out the web
    >>> # space layout for mailing lists now.
    >>> mlist._data.web_page_url = 'http://lists.example.com/'
    >>> flush()

    >>> # Ensure that the virgin queue is empty, since we'll be checking this
    >>> # for new auto-response messages.
    >>> from Mailman.Queue.sbcache import get_switchboard
    >>> virginq = get_switchboard(config.VIRGINQUEUE_DIR)
    >>> virginq.files()
    []

Subscribe a user to the mailing list.

    >>> from Mailman.constants import MemberRole
    >>> user_1 = config.user_manager.create_user('aperson@example.com')
    >>> address_1 = list(user_1.addresses)[0]
    >>> address_1.subscribe(mlist, MemberRole.member)
    <Member: aperson@example.com on _xtest@example.com as MemberRole.member>
    >>> flush()


Non-member posts
----------------

Non-members can't get acknowledgments of their posts to the mailing list.

    >>> msg = message_from_string("""\
    ... From: bperson@example.com
    ...
    ... """, Message)
    >>> process(mlist, msg, {})
    >>> virginq.files()
    []

We can also specify the original sender in the message's metadata.  If that
person is also not a member, no acknowledgment will be sent either.

    >>> msg = message_from_string("""\
    ... From: bperson@example.com
    ...
    ... """, Message)
    >>> process(mlist, msg, dict(original_sender='cperson@example.com'))
    >>> virginq.files()
    []


No acknowledgment requested
---------------------------

Unless the user has requested acknowledgments, they will not get one.

    >>> msg = message_from_string("""\
    ... From: aperson@example.com
    ...
    ... """, Message)
    >>> process(mlist, msg, {})
    >>> virginq.files()
    []

Similarly if the original sender is specified in the message metadata, and
that sender is a member but not one who has requested acknowledgments, none
will be sent.

    >>> user_2 = config.user_manager.create_user('dperson@example.com')
    >>> address_2 = list(user_2.addresses)[0]
    >>> address_2.subscribe(mlist, MemberRole.member)
    <Member: dperson@example.com on _xtest@example.com as MemberRole.member>
    >>> flush()

    >>> process(mlist, msg, dict(original_sender='dperson@example.com'))
    >>> virginq.files()
    []


Requested acknowledgments
-------------------------

If the member requests acknowledgments, Mailman will send them one when they
post to the mailing list.

    >>> user_1.preferences.acknowledge_posts = True
    >>> flush()

The receipt will include the original message's subject in the response body,

    >>> msg = message_from_string("""\
    ... From: aperson@example.com
    ... Subject: Something witty and insightful
    ...
    ... """, Message)
    >>> process(mlist, msg, {})

    >>> len(virginq.files())
    1
    >>> qmsg, qdata = virginq.dequeue(virginq.files()[0])
    >>> virginq.files()
    []
    >>> # Print only some of the meta data.  The rest is uninteresting.
    >>> qdata['listname']
    '_xtest@example.com'
    >>> qdata['recips']
    ['aperson@example.com']
    >>> print qmsg.as_string()
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    Subject: XTest post acknowledgment
    From: _xtest-bounces@example.com
    To: aperson@example.com
    Message-ID: ...
    Date: ...
    Precedence: bulk
    <BLANKLINE>
    Your message entitled
    <BLANKLINE>
        Something witty and insightful
    <BLANKLINE>
    was successfully received by the XTest mailing list.
    <BLANKLINE>
    List info page: http://lists.example.com/listinfo/_xtest@example.com
    Your preferences: http://example.com/aperson@example.com
    <BLANKLINE>

If there is no subject, then the receipt will use a generic message.

    >>> msg = message_from_string("""\
    ... From: aperson@example.com
    ...
    ... """, Message)
    >>> process(mlist, msg, {})

    >>> len(virginq.files())
    1
    >>> qmsg, qdata = virginq.dequeue(virginq.files()[0])
    >>> virginq.files()
    []
    >>> # Print only some of the meta data.  The rest is uninteresting.
    >>> qdata['listname']
    '_xtest@example.com'
    >>> qdata['recips']
    ['aperson@example.com']
    >>> print qmsg.as_string()
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    Subject: XTest post acknowledgment
    From: _xtest-bounces@example.com
    To: aperson@example.com
    Message-ID: ...
    Date: ...
    Precedence: bulk
    <BLANKLINE>
    Your message entitled
    <BLANKLINE>
        (no subject)
    <BLANKLINE>
    was successfully received by the XTest mailing list.
    <BLANKLINE>
    List info page: http://lists.example.com/listinfo/_xtest@example.com
    Your preferences: http://example.com/aperson@example.com
    <BLANKLINE>


Clean up
--------

    >>> for mlist in config.list_manager.mailing_lists:
    ...     config.list_manager.delete(mlist)
    >>> flush()
    >>> list(config.list_manager.mailing_lists)
    []
