Rules
=====

The rule processor is used to determine the status of a message.  Should the
message be posted to the list, or held for moderator approval?  Should the
message be discarded or rejected (i.e. bounced back to the original sender)?

Actually, these actions are not part of rule processing!  Instead, Mailman
first runs through the set of available and requested rules looking for
matches.  Then later, the matched rules are prioritized and matched to an
action.  Action matching is described elsewhere; this documentation describes
only the rule processing system.


Rule sets
---------

IRuleSet is the interface that describes a set of rules.  Mailman can be
extended by plugging in additional rule sets, but it also comes with a default
rule set, called the 'built-in rule set'.

    >>> from zope.interface.verify import verifyObject
    >>> from Mailman.interfaces import IRuleSet
    >>> from Mailman.rules import BuiltinRules
    >>> rule_set = BuiltinRules()
    >>> verifyObject(IRuleSet, rule_set)
    True

You can iterator over all the rules in a rule set.

    >>> from Mailman.interfaces import IRule
    >>> rule = None
    >>> for rule in rule_set.rules:
    ...     if rule.name == 'emergency':
    ...         break
    >>> verifyObject(IRule, rule)
    True
    >>> rule.name
    'emergency'
    >>> print rule.description
    The mailing list is in emergency hold and this message was not pre-approved
    by the list administrator.

You can ask for a rule by name.

    >>> rule_set['emergency'].name
    'emergency'
    >>> rule_set.get('emergency').name
    'emergency'

Rule sets act like dictionaries when the rule is missing.

    >>> rule_set['no such rule']
    Traceback (most recent call last):
    ...
    KeyError: 'no such rule'
    >>> print rule_set.get('no such rule')
    None
    >>> missing = object()
    >>> rule_set.get('no such rule', missing) is missing
    True


Rule checks
-----------

Individual rules can be checked to see if they match, by running the rule's
`check()` method.  This returns a boolean indicating whether the rule was
matched or not.

    >>> from Mailman.configuration import config
    >>> mlist = config.db.list_manager.create(u'_xtest@example.com')
    >>> msg = message_from_string("""\
    ... From: aperson@example.com
    ...
    ... An important message.
    ... """)

For example, the emergency rule just checks to see if the emergency flag is
set on the mailing list, and the message has not been pre-approved by the list
administrator.

    >>> rule = rule_set['emergency']
    >>> rule.name
    'emergency'
    >>> mlist.emergency = False
    >>> rule.check(mlist, msg, {})
    False
    >>> mlist.emergency = True
    >>> rule.check(mlist, msg, {})
    True
    >>> rule.check(mlist, msg, dict(adminapproved=True))
    False


Rule processing
---------------

Mailman has a global rule processor which will return a set of all the rule
names that match the current message.  You can limit the set of rules the
processor will check by passing in a set of requested rule names.

    >>> emergency_only = set(['emergency'])
    >>> from Mailman.app.rules import process
    >>> process(mlist, msg, {}, emergency_only)
    set(['emergency'])
    >>> process(mlist, msg, dict(adminapproved=True), emergency_only)
    set([])
    >>> mlist.emergency = False
    >>> process(mlist, msg, {}, emergency_only)
    set([])
